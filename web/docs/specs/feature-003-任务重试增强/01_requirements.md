# Feature-003 任务重试增强（前端）

## 1. 文档定位
- 类型：新增需求 Spec（To-Be）
- 范围：前端任务管线详情页与任务管线管理页
- 前置：后端接口已就绪（`retry-from-stage`、`retry-batch`）

## 2. 背景与目标
在现有“失败后整任务重试”能力基础上，补充更细粒度和更高效的手动恢复能力：
1. 任务管线详情页支持“从失败节点重试（单节点）”。
2. 任务管线管理页支持“批量重试失败任务（逐任务单节点）”。

## 3. 用户故事
1. 作为研发/值班人员，我希望在任务详情中直接对失败阶段发起重试，避免整任务重跑。
2. 作为运营人员，我希望在任务列表中选中多个失败任务后一键批量重试，减少重复操作。

## 4. 功能范围
1. 任务详情页（`/tasks/:id`）
   - 在失败阶段展示“从失败节点重试”按钮。
   - 点击后调用 `POST /api/v1/tasks/{task_id}/retry-from-stage`。
   - 成功后仅目标失败节点重置为 pending；非目标阶段（含已成功阶段）保持不变。
   - 成功后刷新任务详情与列表缓存。
2. 任务管线页（`/tasks`）
   - 表格增加多选。
   - 工具栏增加“批量重试”按钮。
   - 仅对选中任务中的失败任务执行；非失败任务给出提示并跳过。
   - 调用 `POST /api/v1/tasks/retry-batch` 并展示汇总结果（total/succeeded/failed）。
   - 批量接口对每个任务只执行“失败节点重试”，不做整任务全量失败阶段重置。

## 5. 非目标
- 不修改后端重试规则与状态机。
- 不替换现有 `POST /tasks/{task_id}/retry` 行为。
- 不新增审批/Gate 流程。
- 本需求内不允许将详情页“从失败节点重试”或批量重试降级为“整任务重试”语义。

## 6. 验收标准
1. 详情页失败阶段可见“从失败节点重试”，请求参数包含 `stage_id`。
2. 当接口返回成功时，仅目标失败阶段重置为 pending，非目标阶段不回滚。
3. 任务页支持多选与批量重试，支持混合结果回执展示。
4. 批量重试对每个成功任务仅恢复一个失败节点（按后端规则默认最早失败节点）。
5. 批量重试后任务列表刷新。
6. 对接口失败（4xx/5xx）有可见错误提示。

## 7. 文件路径
### 7.1 需修改
- `src/types/task.ts`
- `src/services/taskApi.ts`
- `src/hooks/useTasks.ts`
- `src/pages/Tasks/TaskDetail.tsx`
- `src/pages/Tasks/index.tsx`

### 7.2 关联文件（只读）
- `src/utils/constants.ts`
- `src/utils/formatters.ts`

## 8. 签名变更约束
详见 `02_interface.md`。

## 9. Mock 数据
详见 `02_interface.md`。
