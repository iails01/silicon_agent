# Feature-003 任务重试增强（前端）- 实现细节

## 1. 实现步骤
1. 在 `task` 类型中补充“阶段重试请求”和“批量重试响应”模型。
2. 在 `taskApi` 新增 `retryTaskFromStage` 与 `retryTasksBatch` 请求方法。
3. 在 `useTasks` 新增对应 mutation hooks，并统一缓存失效策略。
4. 在任务详情页接入“从失败节点重试”按钮与交互反馈。
5. 在任务列表页增加多选与“批量重试”工具栏动作。
6. 统一成功/失败提示文案，并确保操作后刷新列表。
7. 明确语义保护：本功能路径禁止降级为“整任务重试”。

## 2. 页面实现要点

### 2.1 `/tasks/:id` 任务详情页
- 在失败阶段区块渲染“从失败节点重试”按钮（建议 `Popconfirm` 二次确认）。
- 按钮显示条件：
  - `task.status === 'failed'`
  - `stage.status === 'failed'`
- 调用成功：
  - `message.success('已从失败节点重新提交')`
  - 依赖 query 失效自动刷新。
- 调用失败：展示后端错误 `detail`。
- 语义要求：必须调用 `retry-from-stage`，并传当前失败 `stage_id`。

### 2.2 `/tasks` 任务管理页
- 为 `ProTable` 增加 `rowSelection` 与 `selectedRowKeys/selectedRows` 状态。
- 工具栏新增“批量重试”按钮：
  - 未选中：按钮禁用。
  - 选中但无失败任务：提示后不调用接口。
  - 选中含失败任务：仅提交失败任务 ID。
- 语义要求：批量接口返回 success 的任务仅表示“失败节点重试提交成功”，不是全量失败阶段重置。
- 批量结果提示建议：
  - 成功：`已提交批量重试：成功 X，失败 Y`
  - 如有失败明细，追加首条原因或支持弹窗展示列表。

## 3. 异常与边界
1. 后端返回“任务非 failed”/“阶段非 failed”/“重试上限”时，前端透传错误信息。
2. 批量接口部分成功时，不回滚成功项，按后端返回展示统计。
3. 若用户重复点击，使用 mutation `isPending` 禁用按钮避免重复提交。
4. 禁止将批量重试实现为循环调用 `POST /tasks/{task_id}/retry`（该路径语义不等价）。

## 4. 回归检查清单
1. 单任务重试（已有）不受影响。
2. 详情页失败阶段重试按钮只在应出现时出现。
3. 批量重试仅提交失败任务。
4. 批量成功项仅恢复失败节点，已完成阶段不回滚。
5. 操作后任务列表状态刷新。
6. WebSocket/轮询刷新与 mutation 失效不冲突（无明显闪烁与重复提示）。

## 5. 备注
- 本 Spec 仅描述前端改造；后端契约以 `platform/docs/specs/feature-003-任务重试增强` 为准。
