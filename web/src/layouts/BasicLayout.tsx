import React from 'react';
import { Outlet, useNavigate, useLocation } from 'react-router-dom';
import { ProLayout } from '@ant-design/pro-components';
import {
  DashboardOutlined,
  UnorderedListOutlined,
  AuditOutlined,
  ToolOutlined,
  BarChartOutlined,
  FileSearchOutlined,
  FileTextOutlined,
  SettingOutlined,
  ThunderboltOutlined,
  ProjectOutlined,
  ControlOutlined,
  FundOutlined,
} from '@ant-design/icons';
import { Badge } from 'antd';
import { useGateList } from '@/hooks/useGates';

const menuRoutes = {
  routes: [
    { path: '/dashboard', name: '集群总览', icon: <DashboardOutlined /> },
    { path: '/cockpit', name: '指挥台', icon: <ControlOutlined /> },
    { path: '/tasks', name: '任务管线', icon: <UnorderedListOutlined /> },
    { path: '/projects', name: '项目管理', icon: <ProjectOutlined /> },
    { path: '/gates', name: '审批中心', icon: <AuditOutlined /> },
    { path: '/skills', name: 'Skills管理', icon: <ToolOutlined /> },
    { path: '/kpi', name: 'KPI监控', icon: <BarChartOutlined /> },
    { path: '/roi', name: 'ROI 分析', icon: <FundOutlined /> },
    { path: '/audit', name: '审计日志', icon: <FileSearchOutlined /> },
    { path: '/task-logs', name: '任务日志', icon: <FileTextOutlined /> },
    { path: '/config', name: 'Agent配置', icon: <SettingOutlined /> },
    { path: '/circuit-breaker', name: '止损控制', icon: <ThunderboltOutlined /> },
  ],
};

const BasicLayout: React.FC = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { data: pendingGates } = useGateList({ status: 'pending' });
  const pendingGateCount = pendingGates?.length ?? 0;

  return (
    <ProLayout
      title="Silicon Agent"
      layout="mix"
      fixSiderbar
      location={{ pathname: location.pathname }}
      route={menuRoutes}
      menuItemRender={(item, dom) => (
        <a onClick={() => item.path && navigate(item.path)}>
          {item.path === '/gates' && pendingGateCount > 0 ? (
            <Badge count={pendingGateCount} size="small" offset={[8, 0]}>{dom}</Badge>
          ) : (
            dom
          )}
        </a>
      )}
      contentStyle={{ padding: 24 }}
    >
      <Outlet />
    </ProLayout>
  );
};

export default BasicLayout;
